<!-- Dashboard Grid Layout: Explanation â†’ Timeline/Code â†’ Variables/Stack/Stats -->

<!-- Top Row: Explanation (Full Width) -->
<div class="card explanation-card p-6 mb-6">
    <div class="flex items-start gap-4">
        <div class="text-4xl">ğŸ’¡</div>
        <div class="flex-1">
            <div class="text-sm font-semibold text-blue-600 mb-2 uppercase tracking-wide">Current Action</div>
            <h2 class="text-xl font-bold text-gray-900 mb-3">{{ step_data.action }}</h2>
            <p class="text-gray-700 leading-relaxed">
                {{ step_data.explanation }}
            </p>
            
            <!-- Result (if present) -->
            {% if step_data.result is not none %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center gap-2">
                    <strong class="text-gray-900">âœ… Result:</strong>
                    <code class="bg-gray-100 px-3 py-1 rounded text-sm font-mono border border-gray-300">{{ step_data.result }}</code>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="explanation-decision">
            <div class="explanation-decision-label">Decision</div>
            <div class="explanation-decision-value">
                {% if 'covered' in step_data.phase.lower() %}
                    COVERED
                {% elif 'keep' in step_data.phase.lower() %}
                    KEEP
                {% elif 'base_case' in step_data.phase %}
                    BASE CASE
                {% else %}
                    {{ step_data.phase.replace('_', ' ').upper() }}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Middle Row: Timeline (50%) + Code (50%) -->
<div class="grid grid-cols-2 gap-6 mb-6">
    
    <!-- Timeline Visualization -->
    <div class="card p-6">
        <h3 class="card-header">
            <span>ğŸ“Š</span> Interval Timeline
        </h3>
        
        {% if step_data.intervals_state %}
        <div class="space-y-3">
            {% for item in step_data.intervals_state %}
            {% set interval = item.interval %}
            {% set status = item.status %}
            
            <div class="flex items-center gap-3">
                <!-- Interval label -->
                <div class="w-24 text-xs font-mono text-gray-600 text-right font-semibold">
                    {{ interval }}
                </div>
                
                <!-- Visual bar -->
                <div class="flex-1 relative h-12 bg-gray-100 rounded-lg border border-gray-200">
                    <div 
                        class="interval-bar interval-{{ status }}"
                        style="
                            left: {{ (interval[0] / 10) }}%;
                            width: {{ ((interval[1] - interval[0]) / 10) }}%;
                            opacity: {{ item.opacity }};
                            top: 2px;
                        "
                    >
                        {{ interval[1] - interval[0] }}
                    </div>
                </div>
                
                <!-- Status badge -->
                <div class="w-20">
                    {% if status == 'kept' %}
                    <span class="badge badge-kept">âœ“ Kept</span>
                    {% elif status == 'examining' %}
                    <span class="badge badge-examining">ğŸ‘‰ Now</span>
                    {% elif status == 'covered' %}
                    <span class="badge badge-covered">âœ— Skip</span>
                    {% elif status == 'removed' %}
                    <span class="badge badge-pending text-xs">Removed</span>
                    {% else %}
                    <span class="badge badge-pending text-xs">Pending</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Timeline axis -->
        <div class="mt-4 pt-3 border-t border-gray-200">
            <div class="flex justify-between text-xs text-gray-500">
                <span>0</span>
                <span>250</span>
                <span>500</span>
                <span>750</span>
                <span>1000</span>
            </div>
        </div>
        {% else %}
        <div class="text-gray-500 text-center py-8 text-sm">
            No intervals to display
        </div>
        {% endif %}
    </div>

    <!-- Code View -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="card-header mb-0">
                <span>ğŸ“</span> Algorithm Code
            </h3>
            {% if step_data.get('code_line') %}
            <span class="text-xs bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-bold border border-yellow-300">
                Line {{ step_data.code_line }}
            </span>
            {% endif %}
        </div>
        
        <div class="code-container">
            {% set lines = source_code.split('\n') %}
            {% set current_line = step_data.get('code_line', 0) %}
            
            {% for line in lines %}
            <div class="code-line {% if loop.index == current_line %}code-line-active{% endif %}">
                <span class="inline-block w-6 text-right mr-3 text-gray-400 select-none">{{ loop.index }}</span>{{ line }}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Bottom Row: Variables (33%) + Call Stack (33%) + Stats (33%) -->
<div class="grid grid-cols-3 gap-6">
    
    <!-- Variables Panel -->
    <div class="card p-5">
        <h3 class="card-header text-base">
            <span>ğŸ”§</span> Variables
        </h3>
        
        <div class="space-y-2">
            {% if step_data.variables %}
                {% for key, value in step_data.variables.items() %}
                <div class="variable-item">
                    <div class="variable-label">{{ key }}</div>
                    <div class="variable-value">
                        {% if value is sequence and value is not string %}
                            {% if value|length > 3 %}
                                [{{ value[:3]|join(', ') }}, ...]
                            {% else %}
                                {{ value }}
                            {% endif %}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-gray-500 text-center py-4 text-sm">
                    No variables
                </div>
            {% endif %}
        </div>
        
        <!-- Phase badge -->
        <div class="mt-3 pt-3 border-t border-gray-200">
            <span class="inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-bold">
                {{ step_data.phase|replace('_', ' ')|title }}
            </span>
        </div>
    </div>

    <!-- Call Stack Panel -->
    <div class="card p-5">
        <h3 class="card-header text-base">
            <span>ğŸ“</span> Call Stack
        </h3>
        
        {% if step_data.call_stack %}
        <div class="space-y-2">
            {% for call in step_data.call_stack %}
            <div class="stack-item {% if loop.last %}stack-item-active{% endif %}">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">{{ loop.index }}.</span>
                    <span class="flex-1">{{ call }}</span>
                    {% if loop.last %}
                    <span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded font-bold">NOW</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-600">
            <strong>Depth:</strong> {{ step_data.get('depth', 0) }} | 
            <strong>Calls:</strong> {{ step_data.call_stack|length }}
        </div>
        {% else %}
        <div class="text-gray-500 text-center py-4 text-sm">
            No active calls
        </div>
        {% endif %}
    </div>

    <!-- Current Step Stats -->
    <div class="card p-5">
        <h3 class="card-header text-base">
            <span>ğŸ“Š</span> Current Stats
        </h3>
        
        <div class="grid grid-cols-2 gap-2">
            <div class="stat-box stat-blue">
                <div class="stat-label text-xs">Depth</div>
                <div class="stat-value text-2xl">{{ step_data.get('depth', 0) }}</div>
            </div>
            
            <div class="stat-box stat-green">
                <div class="stat-label text-xs">Kept</div>
                <div class="stat-value text-2xl">
                    {{ step_data.intervals_state | selectattr('status', 'equalto', 'kept') | list | length }}
                </div>
            </div>
            
            <div class="stat-box stat-red">
                <div class="stat-label text-xs">Covered</div>
                <div class="stat-value text-2xl">
                    {{ step_data.intervals_state | selectattr('status', 'equalto', 'covered') | list | length }}
                </div>
            </div>
            
            <div class="stat-box stat-purple">
                <div class="stat-label text-xs">Pending</div>
                <div class="stat-value text-2xl">
                    {{ step_data.intervals_state | selectattr('status', 'equalto', 'pending') | list | length }}
                </div>
            </div>
        </div>
        
        <!-- Phase indicator -->
        <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="text-xs text-gray-600 text-center">
                <strong>Phase:</strong> {{ step_data.phase|replace('_', ' ')|title }}
            </div>
        </div>
    </div>
</div>